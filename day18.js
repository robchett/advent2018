'strict mode'
require('./newStdLib');
const advent = require('./advent');

function drawGrid(grid) {
	var out = '';
	for(var j = 0; j < grid.length; j++) {
		for(var i = 0; i < grid.length; i++) {
			out += grid[j][i] || ' '
		}
		out += "\n";
	}

	return out;
}

function parseGrid(input, ticks = 10) {
	var grid = input
		.split("\n")
		.map(a => a.split(""))

	var seenGrids = [];
	var seenPos = false

	for (var i = 0; i < ticks; i++) {
		var strGrid = drawGrid(grid);
		if ((seenPos = seenGrids.indexOf(strGrid)) != -1) {
			return seenGrids[seenPos + ((ticks - i) % (i - seenPos))].uniqc()
		}
		seenGrids.push(strGrid)


		var newGrid = Array(grid.length).fill("").map(a => Array(grid.length).fill(""));
		for (var x = 0; x < grid.length; x++) {
			for (var y = 0; y < grid.length; y++) {
				var surrounds = [
					(y && x) 										? grid[y-1][x-1] 	: false, 
					(y) 											? grid[y-1][x] 		: false,
					(y && x != grid.length -1) 						? grid[y-1][x+1] 	: false,
					(x) 											? grid[y][x-1] 		: false, 
					(x != grid.length - 1) 							? grid[y][x+1] 		: false,
					(y != grid.length - 1 && x) 					? grid[y+1][x-1] 	: false,
					(y != grid.length - 1)							? grid[y+1][x] 		: false,
					(y != grid.length - 1 && x != grid.length -1) 	? grid[y+1][x+1] 	: false,
				].filter(a => a).uniqc()
				switch(grid[y][x]) {
					case '.': {
						newGrid[y][x] = surrounds['|'] >= 3 ? '|' : '.'
						break;
					}
					case '|': {
						newGrid[y][x] = surrounds['#'] >= 3 ? '#' : '|'
						break;
					}
					case '#': {
						newGrid[y][x] = surrounds['#'] && surrounds['|'] ? '#' : '.'
						break;

					}
				}
			}
		}
		grid = newGrid
	}
	return grid.reduce((a,c) => a.concat(c),[]).uniqc()
}

function part1(input) {
	var res = parseGrid(input)
	return res['|'] * res["#"]
}

function part2(input) {
	var res = parseGrid(input, 1000000000)
	return res['|'] * res["#"]
}

var test = `.#.#...|#.
.....#|##|
.|..|...#.
..|#.....#
#.#|||#|#|
...#.||...
.|....|...
||...#|.#|
|.||||..|.
...#.|..|.`
var input = `.||#...#.##...#.#....#.....|.|........|#.....#..|.
....|.#|...|#.|...|......|||..#.#.#.|#.......||..|
...||#....#.#.....|....||..|#.|.|##......##|..#...
.|......#.|#.|....|.##..|.#..|.#..#|.|..|.|.|#..||
.#.||..|...#.|#|.|.#.##.....||...||...#..||...||#.
...|##|#.|....#.|.#..||.#|..#|......#...|.#|.#.#|.
...|..|#..|....||##.........|#..|#|.#|||#..|.|.#||
.#.|#....#....#.|.#....|#.||.||..........##...#|.#
..|..#.|.....|#...#.||..|#....#.....#.||.###.#.||.
..|#||....|..#|.|#..|##...|#..#|.#...#.#|#.##....|
..##|#..|#.|||....#|.#...|.#..#...#...#.#...#.....
|......##.|#|#..#.||...|..##..|#||.|.#|..|#..#...#
...|#...#.....|...|||...||##..||..#.#.||.|...#.|#|
#...|.|.|...||..|#...|..|..#..|.....#...|.|#.|.#|.
#.###..#.||.#...##.|.|..|.#..|##|..|...#.#..#.....
|...#.|.|##.|||..|..|.|.|.....||#..|....|#||..|.|.
..|.|.|..##...|......|#|.........|#.|..|#|..|..###
......|||#..#.#..##.#...##.#.#.###.#..#.||#..#|.|.
.##|#|.|||..#.||#.|.##.#.#|..|..|....####..#.|....
|....#|.|......#|...#..#..##.....#.#.###....#.....
#...#.|#..#.#.#||##||||.|.|..##.|...|.|..#||....|.
.|..#.#.|...|#|#...|#..|.....#.|.|####.|.##..|#...
....##..|#||#.|.#...|.|..###......||..|....|...|..
..#..|.#.#..|#|####.|.......#|#.#..#.#...#.#|#.|.|
...|##.#||.#|.#.|..#|..#|....##.....|..##..#..|##.
..#.|.|||#.##..#.|#...#.#..........||.|.|.#..|....
#.#.##..|#.|.|.#.||..#.||....##....|....#...##|.##
#..|.#.....|#||#.||.|....#|..|##|##|.||..#..#....#
|......|...#...##|#..|..|#.|.....#..#.|...##..#|..
.##.|.#...|#|#.|##.....#....#.|....|##..|.#..|#..#
.|#..#......##..#.#||....|.....#.|.|..|.#|..||#...
#..|#.....|....#...|#|.#|..#|..#.....|.|...|#.....
...|..##|.|.||#..|.#.#|..||.....|##..|#.#..|..|#..
|...#......####.|....|#|...##...|.#||....#...#..|.
.|#..#...#....#.....|.#|#||##.|.##|..#|....|.#....
....#.....##....|#||.#..|#.#...#||....###|...|#.|.
##..|||.....###...#|#|.#.......|...|....||##.##...
..#.|#.|..|...#.#|...|...|#|.#...|..||...|##..#.|#
..#...|...|#.##...#|.||.............|.|....|#....|
....|||...|.|...#.##|.|####||#.|...##...|..||...#.
.............#.....#...|.||#.|.......#......#..|..
......#.||#..#|....#.......#|.....#.|.|##.#.|..#..
...|..#.#..#...#...||.|#....|.||#.#...#..|.|||....
|....|#......|.|..|..|....#.#.#....#.|#..#|.||#|.|
|#..#..#|.#......#.##..|...|.|.....|.#....#.||||..
.|.#..|....#..|###....#|..|....#..|#.|...|......##
..#.......#.|#|||....#|##.....#.#.|...|.#.|.#|.||#
.|.|....|##.#.#.#..|..|.||#...#....#|..|.||##..|..
|.....|##.|...||.||.|.#...#|.|..||.#...|..........
...#|..|.....|..|##.|.|...#||....|..|#..|.|..|#|#|`


advent.test(part1, test, 1147)
advent.run(part1, input);

//advent.test(part2, test, 29);
advent.run(part2, input);
